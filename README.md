# Sighthound docker-compose service


## Quick start

This repo contains a set of docker-compose services that are meant to be handled using the `./scripts/sh-services` script. It is a simple tool that calls `docker-compose up/down` but the main logic resides in the configuration management. The CLI tool reads the `conf` folder of every service and performs a merge (using alphanumeric priority) into the `.env` file that docker-compose uses.

To start, just run:

```
./scripts/sh-services up all
```

and to edit the configuration of services, run:
```
./scripts/sh-services edit all
```

### Available services

#### mcp (Media Control Point)

MCP is a service listening for output fron the SIO analytics container, and providing indexing, time-based access and cleanup services for any media generated by it.

Please keep in mind, that keeping MCP configuration mounted volumes, and `recordTo`/`imageSaveDir` parameters of the SIO pipleine configuration in sync  (i.e. as shipped) is vital to keeping things operational.

If MCP service is disabled and SIO generates media, user MUST provide a cleanup service of their own.

##### Exposed ports
- `9097` : MCP REST API default port
#### sio

SIO is the analytics engine processing the live video feed(s), or provided images, and emitting analytics on the AMQP bus. It also optionally persists images and video from the source.
#### rabbitmq

AMQP broker. If the device operates in a standalone mode, must be enabled. If external AMQP broker is used, SIO and MCP configuration must be adjusted
##### Exposed ports
- `5672` : RabbitMQ default port
- `15672` : RabbitMQ Management console port
#### core

Core sighthound service that creates the `core_sighthound` docker network.
### Configuration

First create the data dirs
1. `mkdir -p /data/sighthound`
2. `mkdir -p /data/sighthound/media`
3. `mkdir -p /data/sighthound/services`
4. `mkdir -p /data/sighthound/license`
5. Install SIO license in `/data/sighthound/license/sighthound-license.json`
6. Uncompress services tarball into `/data/sighthound/services`
7. Modify the `sio.json` file corresponding your sio selected configuration. (Setting the right URL, pipeline parameters...)
8. Finally, create the docker .env files by running: `./scripts/sh-services merge all`

#### SIO pipeline parameters

SIO configuration must be provided in ./sio/conf/sio.json.
This configuration file specifies analytics pipeline(s) to be ran,
and parameters to be passed to each of those.

Some useful pipeline parameters:

```
VIDEO_IN: the RTSP URL to use
fpsLimit: limits the fps intake by the analytis pipeline
```

The following parameters should be kept as is, or set to empty to disable the generation of recorded videeo/images.
```
recordTo: Path for video storage. Should be: /data/sighthound/media/output/video/${sourceId}/
imageSaveDir: Path for image storage. Should be: /data/sighthound/media/output/image/${sourceId}/
```

For more advanced options visit [VehicleAnalytics Documentation](https://dev.sighthound.com/sio/pipelines/VehicleAnalytics/) and [TrafficAnalytics Documentation](https://dev.sighthound.com/sio/pipelines/TrafficAnalytics/)

### Changing Docker env variables

If you need to modify the `.env` file of a service, simply create a new `.env file` like this

```
echo "SIO_DOCKER_TAG=r221202" >  sio/conf/0009-debug.env
```

and then update the services:

```
bash ./scripts/sh-services merge all
```

### Deployment


```
docker network create sh-device-ui_sh-ui-net || true
bash ./scripts/sh-services up all
```


At this point you can test your deployment by going to:

http://localhost:15672 and http://localhost:9097

## Examples

See development example and demonstration scripts at [docs/examples](docs/examples).


### Tips and tricks

For using `sh-services` you may want to run: `export PATH=${PATH}:/data/sighthound/services/scripts` first.

Then you can do commands like:
```
$ sh-services up
```

#### Disabling a service

To disable a service just run:

```
$ touch <service>/disabled
```

#### Re-enabling a service

To enalbe a service just run:

```
$ rm <service>/disabled
```